<!--#insert file="../template/-intro.html" -->
<title>lsctl</title>
<meta name="keywords" content="">
<meta name="description" content="">
<!--#insert file="../template/-outro.html" -->
<style>
  * {
    box-sizing: border-box;
    font-size: 20px;
  }

  .line {
    padding: 20px;
  }

  label {
    display: inline-block;
    width: 120px;
  }

  input,
  select,
  textarea {
    padding: 3px 0 3px 6px;
    width: 360px;
  }

  textarea {
    width: 1800px;
  }

  .ts,
  .side-link {
    position: fixed;
    right: 20px;
    top: 20px;
    text-align: right;
  }

  .ts a {
    display: block;
  }

  .side-link a {
    display: block;
  }

  .side-link {
    top: 250px;
  }

  #copy {
    width: 80px;
  }
</style>
<!--#insert file="../template/-header.html" -->

<div class="line">
  <label for="host">Host</label>
  <input type="text" name="host" id="host">
</div>

<div class="line">
  <label for="date">Date</label>
  <input type="date" name="date" id="date">
</div>

<div class="line">
  <label for="begin">Begin</label>
  <input type="time" name="begin" id="begin">
</div>

<div class="line">
  <label for="end">End</label>
  <input type="time" name="end" id="end">
</div>

<div class="line">
  <label for="cluster">Cluster</label>
  <select name="cluster" id="cluster">
    <option value="">select cluster</option>
    <option value="mc1">mc1</option>
    <option value="kxc1">kxc1</option>
    <option value="mcuat">mcuat</option>
    <option value="cs2">cs2</option>
  </select>
</div>

<div class="line">
  <label for="namespace">Namespace</label>
  <input type="text" name="namespace" id="namespace" value="gfstore">
</div>

<div class="line">
  <label for="serviceName">Name</label>
  <input type="text" name="name" id="serviceName" value="super">
</div>

<div class="line">
  <label for="version">Version</label>
  <input type="text" name="version" id="version" value="1.0.0">
</div>

<div class="line">
  <label for="version">Content Type</label>
  <select name="contentType" id="contentType">
    <option value="0">json</option>
    <option value="1">encoding</option>
    <option value="2" selected>raw</option>
  </select>
</div>

<div class="line">
  <label for="keyword">keyword</label>
  <input type="text" name="keyword" id="keyword" value="">
</div>

<div class="line">
  <input type="button" id="copy" value="copy">
</div>

<div class="line">
  <textarea name="cmd" id="cmd" cols="30" rows="10"></textarea>
</div>

<div class="ts" id="ts"></div>

<div class="side-link" id="sidelink"></div>

<!--#insert file="../template/-footer.html" -->
<!--#insert file="../template/-script.html" -->
<script>
  function timeStr(v) {
    return ('' + v).split(':').filter(v => v).concat('00', '00', '00').slice(0, 3).join(':');
  }
  function initTime() {
    let diff = parseInt(('' + location.hash).replace(/\D/g, ''), 10) || 15;
    console.log('time diff:', diff);
    let now = Date.now() + 8 * 60 * 60 * 1000;
    date.value = new Date(now).toISOString().substring(0, 10);
    begin.value = new Date(now - diff * 60 * 1000).toISOString().substring(11, 19);
    end.value = new Date(now).toISOString().substring(11, 19);
  }
  initTime();
  window.onhashchange = initTime;
  setInterval(() => {
    if (host.value && host.value !== localStorage.inner_host) {
      localStorage.inner_host = host.value;
    }
    begin.value = timeStr(begin.value);
    end.value = timeStr(end.value);
    var keyParam = '';
    if (keyword.value) {
      keyParam = ` --key "${keyword.value.replace(/"/g, '')}"`;
    }
    if (cluster.value) {
      cmd.value = `rm *.log
lsctl import -a --date ${date.value} --begin ${begin.value} --end ${end.value} --clusterTag ${cluster.value} --namespace ${namespace.value} --name ${serviceName.value} --version ${version.value} --contentType ${contentType.value}${keyParam}`;
    } else {
      cmd.value = `rm *.log
lsctl import -a --date ${date.value} --begin ${begin.value} --end ${end.value} --clusterTag kxc1 --namespace ${namespace.value} --name ${serviceName.value} --version ${version.value} --contentType ${contentType.value}${keyParam}
mv ${serviceName.value}.log ${serviceName.value}.kxc1.log
lsctl import -a --date ${date.value} --begin ${begin.value} --end ${end.value} --clusterTag mc1 --namespace ${namespace.value} --name ${serviceName.value} --version ${version.value} --contentType ${contentType.value}${keyParam}
cat ${serviceName.value}.kxc1.log >> ${serviceName.value}.log
rm ${serviceName.value}.kxc1.log
ls -lh
`;
    }
  }, 100);
  [
    [5, '5 minutes'],
    [15, '15 minutes'],
    [30, '30 minutes'],
    [60, '1 hours'],
    [90, '1.5 hours'],
    [120, '2 hours'],
    [240, '4 hours'],
  ].forEach(v => {
    let link = document.createElement('a');
    link.href = '#' + v[0];
    link.innerText = 'last ' + v[1];
    ts.appendChild(link);
  });

  window.onload = function() {
    if (localStorage.inner_host) {
      host.value = localStorage.inner_host;
      [
        ['/', 'LOGIN'],
        ['/is/#/log-insight/tty', 'TERMINAL']
      ].forEach(v => {
        let link = document.createElement('a');
        link.href = 'http://' + host.value + v[0];
        link.innerText = v[1];
        sidelink.appendChild(link);
      });
    }
  };

  copy.onclick = function() {
    cmd.select();
    document.execCommand('copy');
  };
</script>
<!--#insert file="../template/-end.html" -->
