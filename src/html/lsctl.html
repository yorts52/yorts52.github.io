<!--#insert file="../common/-intro.html" -->
<title></title>
<meta name="keywords" content="">
<meta name="description" content="">
<!--#insert file="../common/-outro.html" -->
<style>
  * {
    box-sizing: border-box;
    font-size: 20px;
  }

  .line {
    padding: 20px;
  }

  label {
    display: inline-block;
    width: 120px;
  }

  input,
  select,
  textarea {
    padding: 3px 0 3px 6px;
    width: 360px;
  }

  textarea {
    width: 1234px;
  }

  .ts, .side-link {
    position: fixed;
    right: 20px;
    top: 20px;
    text-align: right;
  }

  .ts a {
    display: block;
  }

  .side-link a {
    display: block;
  }

  .side-link {
    top: 250px;
  }

  #copy {
    width: 80px;
  }
</style>
<!--#insert file="../common/-header.html" -->

<div class="line">
  <label for="host">Host</label>
  <input type="text" name="host" id="host">
</div>

<div class="line">
  <label for="date">Date</label>
  <input type="date" name="date" id="date">
</div>

<div class="line">
  <label for="begin">Begin</label>
  <input type="time" name="begin" id="begin">
</div>

<div class="line">
  <label for="end">End</label>
  <input type="time" name="end" id="end">
</div>

<div class="line">
  <label for="cluster">Cluster</label>
  <select name="cluster" id="cluster">
    <option value="">select cluster</option>
    <option value="mc1">mc1</option>
    <option value="kxc1">kxc1</option>
    <option value="mcuat">mcuat</option>
    <option value="cs2">cs2</option>
  </select>
</div>

<div class="line">
  <label for="namespace">Namespace</label>
  <input type="text" name="namespace" id="namespace" value="gfstore">
</div>

<div class="line">
  <label for="serviceName">Name</label>
  <input type="text" name="name" id="serviceName" value="super">
</div>

<div class="line">
  <label for="version">Version</label>
  <input type="text" name="version" id="version" value="1.0.0">
</div>

<div class="line">
  <input type="button" id="copy" value="copy">
</div>

<div class="line">
  <textarea name="cmd" id="cmd" cols="30" rows="10"></textarea>
</div>

<div class="ts" id="ts"></div>

<div class="side-link" id="sidelink"></div>

<div class="line">
  <textarea name="log" id="log" cols="30" rows="10" placeholder="PASTE AMAZING LOG PLS"></textarea>
</div>

<!--#insert file="../common/-footer.html" -->
<!--#insert file="../common/-script.html" -->
<script>
  function timeStr(v) {
    return ('' + v).split(':').filter(v => v).concat('00', '00', '00').slice(0, 3).join(':');
  }
  function initTime() {
    let diff = parseInt(('' + location.hash).replace(/\D/g, ''), 10) || 15;
    console.log('time diff:', diff);
    let now = Date.now() + 8 * 60 * 60 * 1000;
    date.value = new Date(now).toISOString().substring(0, 10);
    begin.value = new Date(now - diff * 60 * 1000).toISOString().substring(11, 19);
    end.value = new Date(now).toISOString().substring(11, 19);
  }
  initTime();
  window.onhashchange = initTime;
  setInterval(() => {
    if (host.value && host.value !== localStorage.inner_host) {
      localStorage.inner_host = host.value;
    }
    begin.value = timeStr(begin.value);
    end.value = timeStr(end.value);
    if (cluster.value) {
      cmd.value = `rm *.log
lsctl import --date ${date.value} --begin ${begin.value} --end ${end.value} --clusterTag ${cluster.value} --namespace ${namespace.value} --name ${serviceName.value} --version ${version.value}`;
    } else {
      cmd.value = `rm *.log
lsctl import --date ${date.value} --begin ${begin.value} --end ${end.value} --clusterTag kxc1 --namespace ${namespace.value} --name ${serviceName.value} --version ${version.value}
mv ${serviceName.value}.log ${serviceName.value}.kxc1.log
lsctl import --date ${date.value} --begin ${begin.value} --end ${end.value} --clusterTag mc1 --namespace ${namespace.value} --name ${serviceName.value} --version ${version.value}
cat ${serviceName.value}.kxc1.log >> ${serviceName.value}.log
rm ${serviceName.value}.kxc1.log
ls -lh
`;
    }
    logparse();
  }, 100);
  [
    [5, '5 minutes'],
    [15, '15 minutes'],
    [30, '30 minutes'],
    [60, '1 hours'],
    [90, '1.5 hours'],
    [120, '2 hours'],
    [240, '4 hours'],
  ].forEach(v => {
    let link = document.createElement('a');
    link.href = '#' + v[0];
    link.innerText = 'last ' + v[1];
    ts.appendChild(link);
  });

  let prev_log_value = '';
  function logparse() {
    try {
      if (!log.value) return;
      if (prev_log_value == log.value) return;
      prev_log_value = localStorage.last_lsctl_log = log.value;
      window.__log__ = log.value.toString().trim().split('\n').map(v => {
        return ('' + JSON.parse(v).log).trim().replace(/^\[\w+-\d+\] /, '');
      }).join('').replace(/^[\w\W]+?(?:\} (\{)| RESP )/, '$1');
      window.__data__ = JSON.parse(window.__log__);
    } catch (error) {
      console.error('log parse error:', error);
    }
  };

  window.onload = function() {
    if (localStorage.last_lsctl_log) {
      log.value = localStorage.last_lsctl_log;
    }
    if (localStorage.inner_host) {
      host.value = localStorage.inner_host;
      [
        ['/', 'LOGIN'],
        ['/is/#/log-insight/tty', 'TERMINAL']
      ].forEach(v => {
        let link = document.createElement('a');
        link.href = 'http://' + host.value + v[0];
        link.innerText = v[1];
        sidelink.appendChild(link);
      });
    }
  };

  copy.onclick = function() {
    cmd.select();
    document.execCommand('copy');
  };
</script>
<!--#insert file="../common/-end.html" -->